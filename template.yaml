AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Ascenda Template

Globals:
  Function:
    MemorySize: 256
    Architectures: ["arm64"]
    Handler: bootstrap
    Runtime: provided.al2
    Timeout: 5

Resources:

  AscendaApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: Prod
      CorsConfiguration:
        AllowMethods: ['GET', 'POST', 'PUT', 'DELETE']
        AllowHeaders: ['Content-Type', 'X-Amz-Date', 'Authorization', 'X-Api-Key', 'X-Amz-Security-Token']
        AllowOrigins: ['*']
      Auth:
        DefaultAuthorizer: Lambda-Authorizer
        Authorizers:
          Lambda-Authorizer:
            AuthorizerPayloadFormatVersion: 2.0
            FunctionArn: !GetAtt LambdaAuthorizer.Arn
            Identity:
              Headers:
                - Authorization
              ReauthorizeEvery: 300
            EnableSimpleResponses: true
      Domain:
        DomainName: itsag2t2.com
        CertificateArn: arn:aws:acm:ap-southeast-1:163683790602:certificate/17266c11-0d22-4f17-b63f-92e2227151c1
        Route53:
          HostedZoneId: Z01378052RMMURP5MHP9D
          EvaluateTargetHealth: false

  # WebACLAssociation:
  #   Type: AWS::WAFv2::WebACLAssociation
  #   Properties:
  #     ResourceArn: !Ref AscendaApi
  #     WebACLArn: arn:aws:wafv2:ap-southeast-1:163683790602:regional/webacl/AscendaWebACL/0e1a3b1a-5b1a-4b6e-9b9e-3b0b4b5b4b5b

  LambdaAuthorizer:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/lambda-authorizer/
      Handler: bootstrap
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Environment:
        Variables:
          ROLES_TABLE: roles
    Metadata:
      BuildMethod: makefile

  GetMakerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-makers/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /makers
            Method: GET
      Environment: 
        Variables:
          MAKER_TABLE: makers
          LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  CreateMakerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/create-makers/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /makers
            Method: POST
      Environment: 
        Variables:
            USER_TABLE: users
            POINTS_TABLE: points
            MAKER_TABLE: makers
            LOGS_TABLE: logs
      Policies:
        - arn:aws:iam::163683790602:policy/SESEmailActionsPolicy
    Metadata:
      BuildMethod: makefile

  GetCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-checkers/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /checkers
            Method: GET
      Environment: 
        Variables:
          MAKER_TABLE: makers
          LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile
  
  UpdateCheckerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/update-checkers/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /checkers
            Method: PUT
      Environment: 
        Variables:
            USER_TABLE: users
            POINTS_TABLE: points
            MAKER_TABLE: makers
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  GetPointsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-points/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /points
            Method: GET
      Environment: 
        Variables:
          POINTS_TABLE: points
          LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  UpdatePointsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/update-points/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /points
            Method: PUT
      Environment: 
        Variables:
          POINTS_TABLE: points
          LOGS_TABLE: logs
          USER_TABLE: users
          TTL: 1
    Metadata:
      BuildMethod: makefile
  
  CreatePointsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/create-points/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /points
            Method: POST
      Environment: 
        Variables:
          POINTS_TABLE: points
          USER_TABLE: users
          LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  GetUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-users/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /users
            Method: GET
      Environment: 
        Variables:
            USER_TABLE: users
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  CreateUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/create-users/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /users
            Method: POST
      Environment: 
        Variables:
            USER_TABLE: users
            LOGS_TABLE: logs
            TTL: 1
      Policies:
        - arn:aws:iam::163683790602:policy/SESEmailActionsPolicy
        - arn:aws:iam::163683790602:policy/CognitoAccessPolicy
    Metadata:
      BuildMethod: makefile

  UpdateUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/update-users/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /users
            Method: PUT
      Environment: 
        Variables:
          USER_TABLE: users
          LOGS_TABLE: logs
          TTL: 1
      Policies:
        - arn:aws:iam::163683790602:policy/CognitoAccessPolicy
    Metadata:
      BuildMethod: makefile

  DeleteUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/delete-users/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /users
            Method: DELETE
      Environment: 
        Variables:
          USER_TABLE: users
          LOGS_TABLE: logs
          TTL: 1
      Policies:
        - arn:aws:iam::163683790602:policy/CognitoAccessPolicy
    Metadata:
      BuildMethod: makefile

  GetLogsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-logs/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /logs
            Method: GET
      Environment: 
        Variables:
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  GetRolesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/get-roles/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /roles
            Method: GET
      Environment: 
        Variables:
            ROLES_TABLE: roles
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  CreateRolesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/create-roles/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /roles
            Method: POST
      Environment: 
        Variables:
            ROLES_TABLE: roles
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  UpdateRolesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/update-roles/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /roles
            Method: PUT
      Environment: 
        Variables:
            ROLES_TABLE: roles
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

  DeleteRolesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/delete-roles/
      Role: arn:aws:iam::163683790602:role/DynamoDBAccessRole
      Events:
        Api:
          Type: HttpApi
          Properties:
            ApiId: !Ref AscendaApi
            Path: /roles
            Method: DELETE
      Environment: 
        Variables:
            ROLES_TABLE: roles
            LOGS_TABLE: logs
    Metadata:
      BuildMethod: makefile

Outputs:
  AscendaAPI:
    Description: "API Gateway ID"
    Value: !Ref AscendaApi
